<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ›• Darshan Token Booking</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background:#fff7e6; text-align:center; padding:20px }
h1 { color:#8b0000 }
.card { background:white; max-width:460px; margin:20px auto; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.15) }
input,select { width:92%; padding:10px; margin:8px 0; font-size:16px }
button { background:#8b0000; color:white; border:none; padding:12px 24px; font-size:16px; border-radius:6px; cursor:pointer }
button:hover { background:#a30000 }
.hidden { display:none }
.ticket { border:2px dashed #8b0000; padding:15px; margin-top:15px; text-align:left }
.info { font-weight:bold; margin-top:10px }
.status { margin-top:10px; font-weight:bold }
</style>
</head>

<body>

<h1>ğŸ›• Darshan Token Booking</h1>
<p>Police-controlled â€¢ Queue-less Darshan</p>

<div class="card">
  <h3>Step 1: Select Mandir</h3>
  <select id="templeSelect">
    <option value="">Loading mandirsâ€¦</option>
  </select>
  <p class="info">ğŸ“ You must be within <b>5 km</b></p>
  <button onclick="checkLocation()">ğŸ“ Verify Location</button>
  <div id="locationStatus" class="status"></div>
</div>

<div id="details" class="card hidden">
  <h3>Step 2: Devotee Details</h3>
  <input id="nameInput" placeholder="Devotee name (optional)">
  <input type="number" id="count" min="1" max="10" placeholder="Number of people">
  <p class="info">â‚¹2 per token (Demo)</p>
  <button onclick="payAndGenerate()">ğŸ’³ Pay & Generate</button>
</div>

<div id="result" class="card hidden"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBeTQdKmRH788wMrQh4x-IkEt6lt4_rd4E",
  authDomain: "darshan-app-48a19.firebaseapp.com",
  databaseURL: "https://darshan-app-48a19-default-rtdb.firebaseio.com",
  projectId: "darshan-app-48a19",
  messagingSenderId: "1036337719358",
  appId: "1:1036337719358:web:edabaf639a8cabfccb896f"
});
const db = firebase.database();

/* ================= ğŸ”” NOTIFICATION ADDITION ================= */
let notified10Min = false;
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

/* ================= STATE ================= */
let selectedTemple = "";
let batchSize = 0;
let timePerBatch = 0;
let templeCoords = {};
let userId = localStorage.getItem("darshanUserId") || ("U-" + Date.now() + Math.floor(Math.random()*1000));
localStorage.setItem("darshanUserId", userId);

/* ================= LOAD MANDIRS ================= */
db.ref("mandirs").on("value", snap => {
  const sel = document.getElementById("templeSelect");
  sel.innerHTML = '<option value="">-- Select Mandir --</option>';
  snap.forEach(child => {
    const data = child.val();
    if (!data.location) return;
    templeCoords[child.key] = data.location;
    sel.innerHTML += `<option value="${child.key}">${data.mandirName || data.name}</option>`;
  });
});

/* ================= DISTANCE ================= */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ================= LOCATION TEST ================= */
function checkLocation() {
  selectedTemple = templeSelect.value;
  const status = document.getElementById("locationStatus");

  if (!selectedTemple) return alert("Please select a mandir");
  if (!navigator.geolocation) return alert("Geolocation not supported");

  status.innerText = "ğŸ“ Checking your locationâ€¦";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const t = templeCoords[selectedTemple];
      if (!t) return status.innerText = "âŒ Mandir location not configured";

      const d = getDistance(pos.coords.latitude, pos.coords.longitude, t.lat, t.lng);

      if (d <= 5) {
        status.innerText = `âœ… Location verified (${d.toFixed(2)} km away)`;
        fetchSettings();
        checkExistingToken();
      } else {
        status.innerHTML = `âŒ You are ${d.toFixed(2)} km away<br>
          <button onclick="openDirections(${t.lat},${t.lng})">ğŸ§­ Get Directions</button>`;
      }
    },
    () => status.innerText = "âŒ Location permission denied"
  );
}

/* ================= SETTINGS ================= */
function fetchSettings() {
  db.ref("batchSettings/" + selectedTemple).once("value").then(s => {
    if (!s.exists()) return alert("Batch settings not configured yet");
    batchSize = s.val().peoplePerBatch;
    timePerBatch = s.val().timePerBatch;
    details.classList.remove("hidden");
  });
}

/* ================= CHECK EXISTING TOKEN ================= */
function checkExistingToken() {
  db.ref(`userTokens/${userId}/${selectedTemple}`).once("value").then(snap => {
    if (snap.exists()) {
      const tokenData = snap.val();
      const elapsed = Math.floor((Date.now() - tokenData.timestamp)/60000);
      const remaining = tokenData.waitTime - elapsed;
      if (remaining > 0) showToken(tokenData.tokens, remaining);
      else db.ref(`userTokens/${userId}/${selectedTemple}`).remove();
    }
  });
}

/* ================= PAY & GENERATE ================= */
function payAndGenerate() {
  const c = parseInt(count.value);
  if (!c || c < 1) return alert("Invalid count");

  db.ref(`userTokens/${userId}/${selectedTemple}`).once("value").then(snap => {
    if (snap.exists()) return alert("âŒ Active token already exists");

    alert("â‚¹" + (c*2) + " received (Demo)");

    db.ref("nextToken/" + selectedTemple).once("value").then(s => {
      let start = s.val() || 1;
      let tokens = [];
      for (let i=0;i<c;i++) tokens.push(start+i);
      db.ref("nextToken/" + selectedTemple).set(start+c);

      const batchesAhead = Math.floor((start-1)/batchSize);
      const wait = batchesAhead * timePerBatch;

      db.ref(`userTokens/${userId}/${selectedTemple}`).set({
        tokens,
        timestamp: Date.now(),
        waitTime: wait
      });

      showToken(tokens, wait);
    });
  });
}

/* ================= SHOW TOKEN & TIMER ================= */
function showToken(tokens, wait) {
  notified10Min = false;

  result.classList.remove("hidden");
  result.innerHTML = `
    <h3>ğŸ« Tokens</h3>
    <div class="ticket" id="printArea">
      <p><b>Tokens:</b> ${tokens.join(", ")}</p>
      <p><b>Approx wait:</b> <span id="remainingTime">${wait}</span> minutes</p>
    </div>
    <button onclick="printSlip()">ğŸ–¨ Print</button>
  `;

  const timerEl = document.getElementById("remainingTime");
  let remaining = wait;

  const interval = setInterval(() => {
    remaining--;

    /* ğŸ”” 10-MINUTE NOTIFICATION */
    if (remaining === 10 && !notified10Min && Notification.permission === "granted") {
      new Notification("ğŸ›• Darshan Alert", {
        body: "Your darshan is in 10 minutes. Please be ready ğŸ™"
      });
      notified10Min = true;
    }

    if (remaining <= 0) {
      timerEl.innerText = 0;
      clearInterval(interval);
      alert("âœ… Your batch time is over. You can now book a new token.");
      db.ref(`userTokens/${userId}/${selectedTemple}`).remove();
    } else {
      timerEl.innerText = remaining;
    }
  }, 60000);
}

function printSlip() {
  const w = window.open("", "", "width=300,height=400");
  w.document.write("<h3>Darshan Slip</h3>" + printArea.innerHTML);
  w.print();
  w.close();
}
</script>

</body>
</html>
