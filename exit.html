<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üö™ Mandir Exit Gate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Mukta:wght@600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --saffron:#ff9933;
  --gold:#ffd700;
  --deep:#3b1d00;
}

*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  font-family:Poppins,sans-serif;
  background:
    linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.88)),
    url("https://images.unsplash.com/photo-1600788916036-9c46e89f3f8d");
  background-size:cover;
  background-position:center;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:30px 15px;
  color:white;
}

.container{
  width:100%;
  max-width:520px;
}

h2{
  font-family:Mukta,sans-serif;
  text-align:center;
  font-size:2.2rem;
  margin-bottom:25px;
  color:var(--gold);
  letter-spacing:1px;
}

.card{
  background:rgba(255,255,255,.1);
  border:2px solid rgba(255,215,0,.4);
  border-radius:22px;
  padding:28px;
  box-shadow:0 0 35px rgba(255,153,51,.25);
  backdrop-filter:blur(6px);
  margin-bottom:20px;
  animation:fade .6s ease;
}

@keyframes fade{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

input{
  width:100%;
  padding:16px;
  margin:14px 0;
  font-size:18px;
  border-radius:12px;
  border:none;
  outline:none;
}

/* Make placeholder standard size */
input::placeholder{
  font-size:18px;
  color:#ccc;
}

button{
  width:100%;
  padding:18px;
  font-size:18px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:600;
  margin-top:14px;
  transition:.25s;
}

.primary{
  background:linear-gradient(135deg,var(--saffron),var(--gold));
  color:var(--deep);
}

.primary:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 16px rgba(255,215,0,.45);
}

.info{
  font-weight:600;
  font-size:18px;
  margin:14px 0;
  color:#ffe6c1;
  text-align:center;
}

.hidden{display:none}
</style>
</head>

<body>

<div class="container">

<h2>üö™ Mandir Exit Gate</h2>

<!-- Admin Login -->
<div class="card" id="loginCard">
  <input id="adminIdInput" placeholder="Enter Admin ID">
  <button class="primary" onclick="verifyAdmin()">üîê Verify Admin</button>
</div>

<!-- Exit Interface -->
<div class="card hidden" id="exitCard">
  <h3 id="mandirTitle" style="text-align:center;margin-bottom:15px;color:var(--saffron)"></h3>
  <p id="batchInfo" class="info"></p>
  <p id="timerInfo" class="info"></p>
  <button class="primary" onclick="batchOut()">üì§ Batch Out (Next Batch)</button>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBeTQdKmRH788wMrQh4x-IkEt6lt4_rd4E",
  databaseURL: "https://darshan-app-48a19-default-rtdb.firebaseio.com"
});

const db = firebase.database();

let templeId = "";
let batchSize = 0;
let timePerBatch = 5; // default 5 minutes if not set in Firebase
let dayStart = 1;
let currentBatchStart = 1;
let batchStartTime = 0;
let timerInterval = null;

// ================= VERIFY ADMIN =================
function verifyAdmin(){
  const adminId = adminIdInput.value.trim();
  if(!adminId) return alert("Enter Admin ID");

  db.ref("admins/"+adminId).once("value").then(s=>{
    if(!s.exists()) return alert("‚ùå Invalid Admin ID");

    templeId = s.val().templeId;
    loadMandir();
    loadSettings();
    listenBatch();

    loginCard.classList.add("hidden");
    exitCard.classList.remove("hidden");
  });
}

// ================= LOAD MANDIR =================
function loadMandir(){
  db.ref("mandirs/"+templeId).once("value").then(s=>{
    mandirTitle.innerText = "üõï " + s.val().mandirName + " ‚Äì Exit Gate";
  });
}

// ================= LOAD SETTINGS =================
function loadSettings(){
  db.ref("batchSettings/"+templeId).once("value").then(s=>{
    batchSize = s.val().peoplePerBatch || 5;
    timePerBatch = s.val().timePerBatch || 5; // in minutes
  });
}

// ================= LISTEN BATCH =================
function listenBatch(){
  db.ref("nextBatch/"+templeId).on("value", s=>{
    const data = s.val() || { dayStart: 1, currentBatchStart: 1, batchStartTime: 0 };
    dayStart = data.dayStart || 1;
    currentBatchStart = data.currentBatchStart || dayStart;
    batchStartTime = data.batchStartTime || Date.now();
    updateUI();
    startTimer();
  });
}

// ================= UPDATE UI =================
function updateUI(){
  const currentBatchEnd = currentBatchStart + batchSize - 1;
  batchInfo.innerText = `Current Batch Tokens: ${currentBatchStart} ‚Äì ${currentBatchEnd} | Status: INSIDE`;

  // Update timer
  const now = Date.now();
  const elapsedSec = Math.floor((now - batchStartTime)/1000);
  const totalSec = timePerBatch*60;
  const remainingSec = Math.max(totalSec - elapsedSec,0);
  const min = Math.floor(remainingSec/60);
  const sec = remainingSec%60;
  timerInfo.innerText = `‚è±Ô∏è Time Remaining: ${min}:${sec.toString().padStart(2,"0")}`;
}

// ================= TIMER =================
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateUI, 1000);
}

// ================= BATCH OUT =================
function batchOut(){
  const currentBatchEnd = currentBatchStart + batchSize - 1;
  alert(`Batch ${currentBatchStart} ‚Äì ${currentBatchEnd} exited ‚úÖ`);

  // Move to next batch
  currentBatchStart += batchSize;
  batchStartTime = Date.now();

  // Update in Firebase for full sync
  db.ref("nextBatch/"+templeId).update({
    currentBatchStart: currentBatchStart,
    batchStartTime: batchStartTime
  });

  updateUI();
}
</script>

</body>
</html>

