<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ‘® Mandir Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Mukta:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --mandir-red:#8b0000;
  --saffron:#ff9933;
  --gold:#ffd700;
  --bg:#fff7e6;
}

*{box-sizing:border-box}

body{
  font-family:Poppins,sans-serif;
  background:var(--bg);
  margin:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}

/* HEADER */
header{
  width:100%;
  padding:25px;
  background:linear-gradient(135deg,var(--mandir-red),#5e0000);
  color:white;
  text-align:center;
  border-bottom:4px solid var(--gold);
}

header h1{
  font-family:Mukta,sans-serif;
  margin:0;
}

header p{
  margin-top:5px;
  font-size:.9rem;
  opacity:.9;
}

/* BACK LINK */
.back-nav{
  width:100%;
  max-width:460px;
  margin-top:15px;
  padding:0 10px;
}

.back-nav a{
  text-decoration:none;
  color:var(--mandir-red);
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

/* CARD */
.card{
  background:white;
  width:92%;
  max-width:460px;
  margin:20px auto;
  padding:30px;
  border-radius:20px;
  box-shadow:0 15px 35px rgba(139,0,0,.15);
  animation:fadeIn .6s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

h3{
  color:var(--mandir-red);
  border-bottom:2px solid #f3e0c7;
  padding-bottom:10px;
  margin-top:0;
}

input, select{
  width:100%;
  padding:14px;
  margin:10px 0;
  font-size:15px;
  border-radius:12px;
  border:1.5px solid #eee;
}

button{
  width:100%;
  background:linear-gradient(135deg,var(--mandir-red),#b30000);
  color:white;
  border:none;
  padding:15px;
  font-size:15px;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
  margin-top:10px;
}

button:hover{opacity:.95}

.hidden{display:none}

.info{
  background:#fff4db;
  padding:10px;
  border-left:4px solid var(--saffron);
  margin:10px 0;
  font-size:.85rem;
  color:#444;
}

.success{
  color:green;
  font-weight:600;
  margin-top:10px;
}

/* FOOTER */
footer{
  margin-top:auto;
  padding:20px;
  font-size:.8rem;
  color:#888;
}
</style>
</head>

<body>

<header>
  <h1>ðŸ‘® Mandir Admin Panel</h1>
  <p>Secure Darshan Operations Control</p>
</header>

<div class="back-nav">
  <a href="index.html">
    <i class="fa-solid fa-arrow-left"></i> Back to Main Portal
  </a>
</div>

<!-- ================= LOGIN ================= -->
<div class="card" id="loginCard">
  <h3><i class="fa-solid fa-lock"></i> Admin Login</h3>

  <select id="mandirSelect">
    <option value="">Select Your Mandir</option>
  </select>

  <input type="password" id="adminIdInput" placeholder="Admin ID (ADM-XXXXXX)">
  <input type="text" id="phoneInput" placeholder="Phone Number (+91XXXXXXXXXX)">

  <button onclick="sendOTP()">
    <i class="fa-solid fa-mobile-screen"></i> Send OTP
  </button>

  <div id="otpSection" class="hidden">
    <input type="text" id="otpInput" placeholder="Enter OTP">
    <button onclick="verifyOTP()">
      <i class="fa-solid fa-shield-check"></i> Verify & Login
    </button>
  </div>

  <div class="info">
    OTP-based admin access (demo mode)
  </div>
</div>

<!-- ================= SETTINGS ================= -->
<div class="card hidden" id="settingsCard">
  <h3><i class="fa-solid fa-gear"></i> Mandir Settings</h3>

  <p class="info" id="mandirInfo"></p>

  <label>Darshan Start Time</label>
  <input type="time" id="startTime">

  <label>Darshan End Time</label>
  <input type="time" id="endTime">

  <label>People per Batch</label>
  <input type="number" id="peoplePerBatch" min="1">

  <label>Time per Batch (minutes)</label>
  <input type="number" id="timePerBatch" min="1">

  <button onclick="saveSettings()">
    <i class="fa-solid fa-floppy-disk"></i> Save Settings
  </button>

  <p id="settingsStatus" class="success"></p>
</div>

<footer>
  Authorized access only â€¢ Temple Administration ðŸ›•
</footer>

<!-- ================= Firebase ================= -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBeTQdKmRH788wMrQh4x-IkEt6lt4_rd4E",
  authDomain: "darshan-app-48a19.firebaseapp.com",
  databaseURL: "https://darshan-app-48a19-default-rtdb.firebaseio.com",
  projectId: "darshan-app-48a19",
  messagingSenderId: "1036337719358",
  appId: "1:1036337719358:web:edabaf639a8cabfccb896f"
});

const db = firebase.database();

let templeId = "";
let adminId = "";

/* ================= LOAD MANDIRS ================= */
db.ref("mandirs").on("value", snap => {
  mandirSelect.innerHTML = '<option value="">Select Your Mandir</option>';
  snap.forEach(child => {
    const opt = document.createElement("option");
    opt.value = child.key;
    opt.textContent = child.val().mandirName;
    mandirSelect.appendChild(opt);
  });
});

/* ================= SEND OTP (SIMULATED) ================= */
function sendOTP(){
  adminId = adminIdInput.value.trim();
  templeId = mandirSelect.value;
  const phone = phoneInput.value.trim();

  if(!templeId || !adminId || !phone){
    alert("Fill all login details");
    return;
  }

  db.ref("admins/" + adminId).once("value").then(snap => {
    if(!snap.exists() || snap.val().templeId !== templeId){
      alert("âŒ Invalid Admin ID");
      return;
    }

    const otp = Math.floor(100000 + Math.random()*900000);

    db.ref("adminOTP/" + adminId).set({
      otp,
      createdAt: Date.now(),
      expiresIn: 120000
    });

    console.log("ðŸ” OTP (Demo):", otp);
    alert("âœ… OTP generated (demo)");

    otpSection.classList.remove("hidden");
  });
}

/* ================= VERIFY OTP ================= */
function verifyOTP(){
  const entered = otpInput.value.trim();
  if(!entered) return alert("Enter OTP");

  db.ref("adminOTP/" + adminId).once("value").then(snap => {
    if(!snap.exists()) return alert("OTP expired");

    const d = snap.val();
    if(Date.now() - d.createdAt > d.expiresIn) return alert("OTP expired");
    if(entered != d.otp) return alert("Invalid OTP");

    db.ref("adminOTP/" + adminId).remove();
    loginCard.classList.add("hidden");
    settingsCard.classList.remove("hidden");

    loadMandirInfo();
    loadSettings();
  });
}

/* ================= LOAD INFO ================= */
function loadMandirInfo(){
  db.ref("mandirs/" + templeId).once("value").then(snap => {
    const m = snap.val();
    mandirInfo.innerText =
      `Mandir: ${m.mandirName} | Lat ${m.location.lat}, Lng ${m.location.lng}`;
  });
}

/* ================= LOAD SETTINGS ================= */
function loadSettings(){
  db.ref("batchSettings/" + templeId).once("value").then(snap => {
    if(!snap.exists()) return;
    const d = snap.val();
    startTime.value = d.startTime || "";
    endTime.value = d.endTime || "";
    peoplePerBatch.value = d.peoplePerBatch || "";
    timePerBatch.value = d.timePerBatch || "";
  });
}

/* ================= SAVE SETTINGS ================= */
function saveSettings(){
  const data = {
    startTime: startTime.value,
    endTime: endTime.value,
    peoplePerBatch: parseInt(peoplePerBatch.value),
    timePerBatch: parseInt(timePerBatch.value),
    updatedAt: Date.now()
  };

  if(!data.startTime || !data.endTime || !data.peoplePerBatch || !data.timePerBatch){
    alert("Fill all fields");
    return;
  }

  db.ref("batchSettings/" + templeId).set(data).then(()=>{
    settingsStatus.innerText = "âœ… Settings saved successfully";
  });
}
</script>

</body>
</html>

